From 27b9d1d180ac64ed4c25a5bf11c40c995be7b897 Mon Sep 17 00:00:00 2001
From: John Crispin <john@phrozen.org>
Date: Thu, 27 May 2021 13:24:47 +0200
Subject: [PATCH] netifd: update to latest HEAD

Signed-off-by: John Crispin <john@phrozen.org>
---
 package/network/config/netifd/Makefile          |  6 +++---
 .../netifd/patches/002-fix-dhcp-issue.patch     | 17 +++++++++++++++++
 2 files changed, 20 insertions(+), 3 deletions(-)
 create mode 100644 package/network/config/netifd/patches/002-fix-dhcp-issue.patch

diff --git a/package/network/config/netifd/Makefile b/package/network/config/netifd/Makefile
index 4b5f110da2..32ed4edb42 100644
--- a/package/network/config/netifd/Makefile
+++ b/package/network/config/netifd/Makefile
@@ -5,9 +5,9 @@ PKG_RELEASE:=1
 
 PKG_SOURCE_PROTO:=git
 PKG_SOURCE_URL=$(PROJECT_GIT)/project/netifd.git
-PKG_SOURCE_DATE:=2021-07-26
-PKG_SOURCE_VERSION:=440eb0647708274cc8d7d9e7c2bb0cfdfba90023
-PKG_MIRROR_HASH:=eed957036ab608fdc49bdf801fc5b4405fcd2a3a5e5d3343ec39898e156c10e9
+PKG_SOURCE_DATE:=2021-05-26
+PKG_SOURCE_VERSION:=1eb0fafaa9865b729509a7d47ecf1f05c2c0595c
+PKG_MIRROR_HASH:=81ff2a20225b41e197fd2dcb86068459d868cbc8b23700c8f011806452d553e8
 PKG_MAINTAINER:=Felix Fietkau <nbd@nbd.name>
 
 PKG_LICENSE:=GPL-2.0
diff --git a/package/network/config/netifd/patches/002-fix-dhcp-issue.patch b/package/network/config/netifd/patches/002-fix-dhcp-issue.patch
new file mode 100644
index 0000000000..6f1d2e708e
--- /dev/null
+++ b/package/network/config/netifd/patches/002-fix-dhcp-issue.patch
@@ -0,0 +1,17 @@
+Index: netifd-2019-08-05-5e02f944/interface.c
+===================================================================
+--- netifd-2019-08-05-5e02f944.orig/interface.c
++++ netifd-2019-08-05-5e02f944/interface.c
+@@ -424,7 +424,11 @@ interface_main_dev_cb(struct device_user
+ 		interface_set_link_state(iface, false);
+ 		break;
+ 	case DEV_EVENT_TOPO_CHANGE:
+-		interface_proto_event(iface->proto, PROTO_CMD_RENEW, false);
++	/* This renews the dhcp lease when the bridge adds/deletes a
++	 * new interface. It causes some dhcp servers to fail in
++	 * case where there are many interfaces being added to the
++	 * bridge frequently. Disabling this for now. */
++	/*	interface_proto_event(iface->proto, PROTO_CMD_RENEW, false); */
+ 		return;
+ 	default:
+ 		break;
-- 
2.25.1

